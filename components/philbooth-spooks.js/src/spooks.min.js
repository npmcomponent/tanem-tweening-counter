(function(n){"use strict";function r(n){return v({name:n.name,log:n.log,result:i({archetype:t(n.archetype),log:n.log,chains:n.chains,results:n.results,callbacks:n.callbacks,mode:n.mode})})}function t(n){if(o(n.instance))return n.instance;if(e(n.ctor))return u(n.args)?c(n.ctor,n.args):new n.ctor;throw Error("Invalid archetype")}function o(n){return"object"==typeof n&&null!==n}function e(n){return"function"==typeof n}function u(n){return"[object Array]"===Object.prototype.toString.call(n)}function c(n,r){function t(){return n.apply(this,r)}return t.prototype=n.prototype,new t}function i(n){var r=n.archetype,t=n.spook||{};if(s(r)&&h(r))throw Error("Invalid archetype");if(s(n.log))throw Error("Invalid log");return a(r,t,{log:n.log,chains:n.chains||{},results:n.results||{},callbacks:n.callbacks||{},mode:n.mode||0}),t}function a(n,r,t){var o;for(o in n)p(n,o,t.mode)&&(r[o]=f(n,o,t));return r}function f(n,r,t){var o=n[r];return e(o)?a(o,v({name:r,log:t.log,chain:t.chains[r],result:t.results[r],callback:t.callbacks[r]}),t):s(o)?o:u(o)?l(o,t):a(o,{},t)}function l(n,r){var t,o=[];for(t=0;n.length>t;t+=1)o.push(f(n,t,r));return o}function s(n){return o(n)===!1}function h(n){return e(n)===!1}function p(n,r,t){return n.hasOwnProperty(r)===!1&&d(t)===!1?!1:o(n[r])?y(t):h(n[r])?m(t):!0}function d(n){return g(O.heavy,n)}function g(n,r){return(n&r)===n}function y(n){return g(O.deep,n)}function m(n){return g(O.wide,n)}function v(n){var r=n.name,t=n.chain,o=n.log,e=n.result,u=n.callback;if("string"!=typeof r)throw Error("Invalid function name");if(u&&"function"!=typeof u)throw Error("Invalid callback function");return b(o,r,{counts:0,args:[],these:[]}),function(){return E(r,o,arguments,this),u&&u(),t===!0?this:e}}function b(n,r,t){var o;for(o in t)t.hasOwnProperty(o)&&w(n,o,r,t[o])}function w(n,r,t,o){k(n,r,{}),k(n[r],t,o)}function k(n,r,t){n[r]===void 0&&(n[r]=t)}function E(n,r,t,o){r.counts[n]+=1,r.args[n].push(t),r.these[n].push(o)}function I(n){var r,t,o=0,e=n.split(",");for(r=0;e.length>r;r+=1){if(t=O[e[r].trim()],t===void 0)throw Error("Invalid mode");o|=t}return o}function j(){"function"==typeof define&&define.amd?define(function(){return P}):"undefined"!=typeof module&&null!==module?module.exports=P:n.spooks=P}var O={wide:1,deep:2,heavy:4},P={ctor:r,obj:i,fn:v,mode:I};j()})(this);